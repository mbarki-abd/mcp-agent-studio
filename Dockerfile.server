# Build stage
FROM node:20-alpine AS builder

WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate

# Copy all workspace config files first
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY turbo.json ./

# Copy package.json files for all packages
COPY packages/types/package.json ./packages/types/
COPY server/package.json ./server/

# Install ALL dependencies
RUN pnpm install

# Copy source files
COPY packages/types ./packages/types
COPY server ./server
COPY tsconfig.json ./

# Install build tools globally (pnpm hoisting doesn't put them in workspace package node_modules)
RUN npm install -g tsup typescript prisma@5.22.0

# Build types first using global tsup
WORKDIR /app
RUN tsup packages/types/src/index.ts --outDir packages/types/dist --format cjs,esm --dts

# Build server
WORKDIR /app/server
RUN prisma generate
RUN pnpm build

WORKDIR /app

# Production stage
FROM node:20-alpine AS runner

WORKDIR /app

# Install OpenSSL for Prisma (required for Alpine Linux)
RUN apk add --no-cache openssl

# Install pnpm and prisma 5.x globally (to avoid npx downloading 7.x)
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate && npm install -g prisma@5.22.0

# Copy built files and workspace config
COPY --from=builder /app/package.json ./
COPY --from=builder /app/pnpm-workspace.yaml ./
COPY --from=builder /app/pnpm-lock.yaml ./
COPY --from=builder /app/packages/types/package.json ./packages/types/
COPY --from=builder /app/packages/types/dist ./packages/types/dist
COPY --from=builder /app/server/package.json ./server/
COPY --from=builder /app/server/dist ./server/dist
COPY --from=builder /app/server/prisma ./server/prisma

# Install production dependencies only
RUN pnpm install --prod --frozen-lockfile

# Generate Prisma client in the production image (with correct binaries for Alpine)
WORKDIR /app/server
RUN prisma generate

# Set environment
ENV NODE_ENV=production
ENV PORT=3000

EXPOSE 3000

# Run migrations and start
CMD ["sh", "-c", "prisma migrate deploy && node dist/index.js"]
